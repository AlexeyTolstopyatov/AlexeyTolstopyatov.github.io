---
layout: post
title: "MZ-Executable | DOS Executable"
date:   2025-08-14 18:00:00 +0700
categories: notes 
---

MZ Executable image is a type of DOS program which came since PC-DOS 1.0 was released.
PC-DOS `.EXE`-program always starts with `MZ` or `ZM` (ASCII `WORD`) signature.
This is a main sign for image detection. 

Every DOS program marked as `.EXE`cutable binary has two critical important
parts for OS loader. 

### MZ Header

Here is an structure written on Rust language for example.

```rust
struct MzHeader{
    // Standard "DOS Header"
    pub e_sign: Lu16,       // ZM or MZ
    pub e_cblp: Lu16,       // Last Block                   (*)
    pub e_cp: Lu16,         // Count of pages/blocks        (*)
    pub e_relc: Lu16,       // Count of relocations         (*)
    pub e_cparhdr: Lu16,    // Header's size (in blocks)    (*)
    pub e_minep: Lu16,      // Minimum required RAM in blocks
    pub e_maxep: Lu16,      // Required by program RAM in blocks
    pub ss: Lu16,           // (I8086) Stack Segment        (*)
    pub sp: Lu16,           // (I8086) Stack Pointer        (*)
    pub e_check: Lu16,      // Checksum of image [ignores]
    pub ip: Lu16,           // (I8086) Instruction Pointer  (*)
    pub cs: Lu16,           // (I8086) Code Segment         (*)
    pub e_lfarlc: Lu16,     // Relocation table
    
    // "Extended DOS Header" or "MZ-Header" 
    pub e_ovno: Lu16,        // Current overlay's number [ignores]
    pub e_res0x1c: [Lu16; 4],// [ignores]
    pub e_oemid: Lu16,       // [ignores]
    pub e_oeminfo: Lu16,     // [ignores]
    pub e_res_0x28: [Lu16; 10], // [ignores]
    pub e_lfanew: Lu32,         // MS-DOS 4.+ application starts to have it non-zero 
}
```

"Clear" DOS images hold `e_lfanew` field zero. Sunflower bases on it to define
executable image as true MS-DOS images. 

The `(*)` marked values not takes by DOS loader as it holds in data structure!
MS-DOS takes those values and computes actually system information about program.

The `[ignores]`-marked values are ignores by PC-DOS and MS-DOS loaders. 

#### Overlays

Overlays for DOS programs also have MZ-Header but fields, which ignores by loader
and `e_lfanew` field equals zero.

> The "Perfect Binary" as a concept means binary image, which
> holds on right optional (ignoring by loader) information. 

If `e_ovno` field has non-zero value in main `.EXE` part,
this may warn you about malware victim or special corrupted image. (???)

### MZ Relocation Table

Count of relocations tells `e_relc` field and this is a main flag
to correctly read relocations for DOS image.

The relocations have `16:16` format or (more well-known) `FAR` pointer format.

```rust
struct MZRelocation {
    pub r_offset: u16,
    pub r_segment: u16,
}
```

```rust
/// Rust pseudo-code for reading relocations
fn read_relocs(...) -> Vec::<MZRelocation> {
    let rel_vec: Vec::<MZRelocation> = Vec::<MZRelocation>::new();
    
    reader.seek(e_lfarlc, 0);
    if e_lfarlc = 0 {
        return rel_vec;
    }

    for i in 0..e_relc {
        let rel: MZRelocation = reader
            .read_bytes(4)
            .to_struct::<MZRelocation>();
        
        rel_vec.push(rel);
    }

    return rel_vec;
}
```

But for real, `MZRelocation` datastructure is a comfortable view of
relocations in image. PC-DOS and MS-DOS catch relocations like `16:16` raw value (`r_segoff: u32`).

Sunflower uses datastructure way to show raw not prepared by DOS relocations
when PC/MS-DOS MZ plugin works.